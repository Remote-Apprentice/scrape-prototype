<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Backpage Bot</title>
    <link rel="stylesheet" href="libs/bootstrap.min.css">
    <link rel="stylesheet" href="main.css">
  </head>
  <body>
  <!DOCTYPE html>
  <html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Google, Wikipedia, Ranker Scraper</title>
    <link rel="stylesheet" href="libs/bootstrap.min.css">
    <link rel="stylesheet" href="main.css">
  </head>
  <body>
  <div class="container">
    <form>
      <div class="form-group">
        <label for="proxy_name">Proxy Name</label>
        <input type="text" class="form-control" id="proxy_name" placeholder="Proxy Name">
      </div>
      <div class="form-group">
        <label for="proxy_ip">I.P. Address</label>
        <input type="text" class="form-control" id="proxy_ip" placeholder="Proxy I.P.">
      </div>
      <div class="form-group">
        <label for="proxy_port">Proxy Port</label>
        <input type="text" class="form-control" id="proxy_port" placeholder="Proxy Port">
      </div>
      <div class="form-group">
        <label for="proxy_user">Proxy User</label>
        <input type="text" class="form-control" id="proxy_user" placeholder="Proxy User">
      </div>
      <div class="form-group">
        <label for="proxy_pass">Proxy Password</label>
        <input type="password" class="form-control" id="proxy_pass" placeholder="Proxy Password">
      </div>
      <div class="form-group">
        <button class="btn btn-primary form-control" type="button" onclick="addProxy()">Save Proxy</button><br/><br/>
      </div>
    </form>
    <form>
      <div class="form-group">
        <label for="search_term">Search term</label>
        <input type="text" class="form-control" id="search_term" placeholder="Search term">
      </div>
      <div class="form-group">
        <button class="btn btn-primary form-control" type="button" onclick="startScrape()">Start scrape</button><br/><br/>
      </div>


    </form>
    <ul id="proxies">

    </ul>
  </div>
  <script>
    // You can also require other files to run in this process
    require('./renderer.js')

  </script>
  <script>window.$ = window.jQuery = require('./libs/jquery-3.2.1.min.js');</script>
  <script src="libs/bootstrap.min.js"></script>
  <script>

     const flat = require('node-flat-db');
     const storage = require('node-flat-db/file-async');

     const db = flat('data/proxies.json', { storage });

     const proxies = db('proxies').map('name');
      console.log(proxies)
     for(var x= 0; x< db('proxies').size(); x++){
         $('#proxies').append(`<li id="${proxies[x]}">` + proxies[x] + ` <button class="text-danger" id="delete" onclick="deleteProxy(${proxies[x]})">x</button></li>`)
     }

     function addProxy(){
             db('proxies').push({
                 name: $('#proxy_name').val(),
                 addr: $('#proxy_ip').val(),
                 port: $('#proxy_port').val(),
                 user: $('#proxy_user').val(),
                 pass: $('#proxy_pass').val()
             })
                 .then(proxy => {

                     $('#proxies').append(`<li id="${proxy[proxy.length-1].name}">` + proxy[proxy.length-1].name + ` <button class="text-danger" id="delete" onclick="deleteProxy(${proxy[proxy.length-1].name})">x</button></li>`)

                 })

             $('#proxy_name').val('')
             $('#proxy_ip').val('')
             $('#proxy_port').val('')
             $('#proxy_user').val('')
            $('#proxy_pass').val('')

     }
     function deleteProxy(proxy){
         console.log('deleted', proxy.id);
         db('proxies').remove({ name: proxy.id })
         $('#' + proxy.id).remove();
     }
   </script>

  <script>
      var Nightmare = require('nightmare');
      var nightmare = Nightmare({ show: true });
    function startScrape(){
        console.log('Scraping google...')
        getGoogle();
        getRanker();
        getWiki();
    }

    function getGoogle(){
        nightmare
            .goto('https://google.com')
            .type('#lst-ib', $('#search_term').val())
            .type('#lst-ib', '\u000d')
            /*.wait('#zero_click_wrapper .c-info__title a')
             .evaluate(function () {
             return document.querySelector('#zero_click_wrapper .c-info__title a').href;
             })
             //.end()*/
            .then(function (result) {
                console.log(result);
            })
            .catch(function (error) {
                console.error('Search failed:', error);
            });
    }

    function getRanker(){
        console.log('Scraping Ranker...not working without proxy')
    }

    function getWiki(){
        console.log('Scraping Wikipedia...')
        nightmare
            .wait(10000)
            .goto('https://google.com')
            .type('#lst-ib', 'wikipedia ' + $('#search_term').val())
            .type('#lst-ib', '\u000d')
            /*.wait('#zero_click_wrapper .c-info__title a')
             .evaluate(function () {
             return document.querySelector('#zero_click_wrapper .c-info__title a').href;
             })
             //.end()*/
            .then(function (result) {
                console.log(result);
            })
            .catch(function (error) {
                console.error('Search failed:', error);
            });
    }
  </script>
  </body>
</html>
